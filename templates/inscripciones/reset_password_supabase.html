{% extends 'inscripciones/base.html' %}

{% block title %}Restablecer Contraseña - Sistema de Prácticas{% endblock %}

{% block extra_head %}
<style>
    .password-strength {
        margin-top: 0.5rem;
        padding: 0.5rem;
        border-radius: 8px;
        font-size: 0.85rem;
    }
    .password-strength.weak {
        background-color: #fee;
        color: #c00;
    }
    .password-strength.medium {
        background-color: #ffc;
        color: #660;
    }
    .password-strength.strong {
        background-color: #efe;
        color: #060;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="form-container" style="margin: 0;">
                <div class="form-header">
                    <h2>
                        <i class="bi bi-key-fill"></i> Restablecer Contraseña
                    </h2>
                    <p>Ingresa tu nueva contraseña para recuperar el acceso a tu cuenta</p>
                </div>

                <!-- Mensajes de alerta del sistema -->
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            <i class="bi bi-{% if message.tags == 'success' %}check-circle-fill{% elif message.tags == 'error' or message.tags == 'danger' %}x-circle-fill{% elif message.tags == 'warning' %}exclamation-triangle-fill{% else %}info-circle-fill{% endif %}"></i>
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}

                <form method="post" id="resetPasswordForm">
                    {% csrf_token %}
                    
                    <!-- Campo oculto para el access_token -->
                    <input type="hidden" name="access_token" id="access_token">
                    
                    <div class="form-group mb-3">
                        <label for="password1" class="form-label">
                            <i class="bi bi-lock-fill"></i> Nueva Contraseña
                        </label>
                        <div style="position: relative;">
                            <input type="password" 
                                   name="password1" 
                                   class="form-control" 
                                   id="password1"
                                   placeholder="Mínimo 6 caracteres"
                                   required
                                   minlength="6"
                                   style="padding-right: 45px;">
                            <button type="button" 
                                    onclick="togglePasswordField('password1')" 
                                    style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 5px;"
                                    title="Mostrar/Ocultar contraseña">
                                <i class="bi bi-eye-fill" id="password1-toggle-icon" style="font-size: 1.2rem; color: var(--uleam-blue);"></i>
                            </button>
                        </div>
                        <div id="passwordStrength" class="password-strength" style="display: none;"></div>
                        <small class="form-text text-muted">
                            <i class="bi bi-info-circle"></i> La contraseña debe tener al menos 6 caracteres
                        </small>
                    </div>
                    
                    <div class="form-group mb-4">
                        <label for="password2" class="form-label">
                            <i class="bi bi-lock-fill"></i> Confirmar Contraseña
                        </label>
                        <div style="position: relative;">
                            <input type="password" 
                                   name="password2" 
                                   class="form-control" 
                                   id="password2"
                                   placeholder="Repite la contraseña"
                                   required
                                   minlength="6"
                                   style="padding-right: 45px;">
                            <button type="button" 
                                    onclick="togglePasswordField('password2')" 
                                    style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 5px;"
                                    title="Mostrar/Ocultar contraseña">
                                <i class="bi bi-eye-fill" id="password2-toggle-icon" style="font-size: 1.2rem; color: var(--uleam-blue);"></i>
                            </button>
                        </div>
                        <div id="passwordMatch" style="margin-top: 0.5rem; font-size: 0.85rem;"></div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn-submit" id="submitBtn">
                            <i class="bi bi-check-circle-fill"></i> Restablecer Contraseña
                        </button>
                        <a href="{% url 'login' %}" class="btn-cancel">
                            <i class="bi bi-x-circle-fill"></i> Cancelar
                        </a>
                    </div>
                </form>
                
                <div class="text-center mt-3">
                    <a href="{% url 'home' %}" style="color: var(--uleam-blue); text-decoration: none;">
                        <i class="bi bi-house-fill"></i> Volver al inicio
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Extraer el access_token del fragmento de URL (#access_token=...)
window.addEventListener('DOMContentLoaded', function() {
    const hash = window.location.hash;
    
    if (hash) {
        const params = new URLSearchParams(hash.substring(1));
        const accessToken = params.get('access_token');
        const type = params.get('type');
        
        if (accessToken && type === 'recovery') {
            // Token válido, mostrarlo en el campo oculto
            document.getElementById('access_token').value = accessToken;
            console.log('✅ Token de recuperación detectado');
        } else {
            // No hay token válido
            console.warn('⚠️ No se detectó token de recuperación válido');
            const formContainer = document.querySelector('.form-container');
            formContainer.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle-fill"></i>
                    <strong>Error:</strong> El enlace de recuperación es inválido o ha expirado.
                    Por favor, <a href="{% url 'solicitar_restablecimiento_contrasena' %}">solicita uno nuevo</a>.
                </div>
                <div class="text-center mt-3">
                    <a href="{% url 'home' %}" class="btn btn-primary">
                        <i class="bi bi-house-fill"></i> Volver al inicio
                    </a>
                </div>
            `;
        }
    }
    
    // Validación de fortaleza de contraseña
    const password1 = document.getElementById('password1');
    const password2 = document.getElementById('password2');
    const passwordStrength = document.getElementById('passwordStrength');
    const passwordMatch = document.getElementById('passwordMatch');
    
    password1.addEventListener('input', function() {
        const value = this.value;
        const strength = calculatePasswordStrength(value);
        
        if (value.length > 0) {
            passwordStrength.style.display = 'block';
            passwordStrength.textContent = strength.text;
            passwordStrength.className = 'password-strength ' + strength.class;
        } else {
            passwordStrength.style.display = 'none';
        }
        
        checkPasswordMatch();
    });
    
    password2.addEventListener('input', checkPasswordMatch);
    
    function togglePasswordField(inputId) {
        const passwordInput = document.getElementById(inputId);
        const icon = document.getElementById(inputId + '-toggle-icon');
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            icon.classList.remove('bi-eye-fill');
            icon.classList.add('bi-eye-slash-fill');
        } else {
            passwordInput.type = 'password';
            icon.classList.remove('bi-eye-slash-fill');
            icon.classList.add('bi-eye-fill');
        }
    }
    
    function calculatePasswordStrength(password) {
        let score = 0;
        
        if (password.length >= 6) score++;
        if (password.length >= 10) score++;
        if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score++;
        if (/\d/.test(password)) score++;
        if (/[@$!%*?&]/.test(password)) score++;
        
        if (score <= 2) {
            return { text: '⚠️ Contraseña débil', class: 'weak' };
        } else if (score <= 4) {
            return { text: '✓ Contraseña media', class: 'medium' };
        } else {
            return { text: '✅ Contraseña fuerte', class: 'strong' };
        }
    }
    
    function checkPasswordMatch() {
        const val1 = password1.value;
        const val2 = password2.value;
        
        if (val2.length > 0) {
            if (val1 === val2) {
                passwordMatch.innerHTML = '<span style="color: #060;"><i class="bi bi-check-circle-fill"></i> Las contraseñas coinciden</span>';
            } else {
                passwordMatch.innerHTML = '<span style="color: #c00;"><i class="bi bi-x-circle-fill"></i> Las contraseñas no coinciden</span>';
            }
        } else {
            passwordMatch.innerHTML = '';
        }
    }
    
    // Validación antes de enviar
    const form = document.getElementById('resetPasswordForm');
    form.addEventListener('submit', function(e) {
        const val1 = password1.value;
        const val2 = password2.value;
        const token = document.getElementById('access_token').value;
        
        if (!token) {
            e.preventDefault();
            alert('❌ Error: No se detectó un token válido. Por favor, usa el enlace del correo electrónico.');
            return;
        }
        
        if (val1 !== val2) {
            e.preventDefault();
            alert('❌ Las contraseñas no coinciden');
            return;
        }
        
        if (val1.length < 6) {
            e.preventDefault();
            alert('❌ La contraseña debe tener al menos 6 caracteres');
            return;
        }
        
        // Deshabilitar botón para evitar doble clic
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Procesando...';
    });
});
</script>
{% endblock %}
